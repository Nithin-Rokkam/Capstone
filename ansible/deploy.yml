---
- name: Deploy News Recommender API to AWS EC2
  hosts: aws_ec2
  become: yes
  gather_facts: yes
  
  vars:
    app_name: news-recommender-api
    app_user: newsrec
    app_group: newsrec
    app_home: /home/newsrec
    app_dir: "{{ app_home }}/news-recommender-api"
    venv_dir: "{{ app_dir }}/venv"
    data_dir: "{{ app_dir }}/data"
    newsapi_key: "{{ newsapi_api_key }}"
    
  tasks:
    # System updates
    - name: Update system packages
      yum:
        name: "*"
        state: latest
      when: ansible_os_family == "RedHat"
    
    - name: Update system packages (Ubuntu)
      apt:
        update_cache: yes
        upgrade: dist
      when: ansible_os_family == "Debian"
    
    # Install dependencies
    - name: Install required system packages (RedHat)
      yum:
        name:
          - python3
          - python3-pip
          - python3-devel
          - git
          - gcc
          - nginx
          - supervisor
          - curl
          - wget
        state: present
      when: ansible_os_family == "RedHat"
    
    - name: Install required system packages (Ubuntu)
      apt:
        name:
          - python3
          - python3-pip
          - python3-venv
          - python3-dev
          - git
          - gcc
          - nginx
          - supervisor
          - curl
          - wget
        state: present
      when: ansible_os_family == "Debian"
    
    # Create application user
    - name: Create application user
      user:
        name: "{{ app_user }}"
        home: "{{ app_home }}"
        shell: /bin/bash
        createhome: yes
        state: present
    
    # Clone repository
    - name: Clone repository
      git:
        repo: "https://github.com/YOUR_USERNAME/News-Recommender-Enhanced-API.git"
        dest: "{{ app_dir }}"
        version: main
        force: yes
      become_user: "{{ app_user }}"
    
    # Create virtual environment
    - name: Create Python virtual environment
      command: python3 -m venv "{{ venv_dir }}"
      become_user: "{{ app_user }}"
      args:
        creates: "{{ venv_dir }}/bin/activate"
    
    # Install Python dependencies
    - name: Install Python dependencies
      pip:
        requirements: "{{ app_dir }}/requirements.txt"
        virtualenv: "{{ venv_dir }}"
        virtualenv_python: python3
      become_user: "{{ app_user }}"
    
    # Create data directory
    - name: Create data directory
      file:
        path: "{{ data_dir }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0755'
    
    # Download data (optional - only if needed)
    - name: Download MIND dataset
      command: "{{ venv_dir }}/bin/python {{ app_dir }}/download_data.py"
      become_user: "{{ app_user }}"
      environment:
        PYTHONPATH: "{{ app_dir }}"
      async: 3600
      poll: 30
      ignore_errors: yes
    
    # Create .env file
    - name: Create .env file
      template:
        src: env.j2
        dest: "{{ app_dir }}/.env"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0600'
    
    # Configure Supervisor for FastAPI
    - name: Create supervisor config for FastAPI
      template:
        src: supervisor_fastapi.conf.j2
        dest: /etc/supervisor/conf.d/news-recommender-api.conf
      notify: restart supervisor
    
    # Configure Nginx
    - name: Create nginx config
      template:
        src: nginx.conf.j2
        dest: /etc/nginx/sites-available/news-recommender-api
      notify: restart nginx
    
    - name: Enable nginx site
      file:
        src: /etc/nginx/sites-available/news-recommender-api
        dest: /etc/nginx/sites-enabled/news-recommender-api
        state: link
      notify: restart nginx
    
    - name: Remove default nginx site
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: restart nginx
    
    # Start services
    - name: Enable and start supervisor
      systemd:
        name: supervisor
        enabled: yes
        state: started
    
    - name: Enable and start nginx
      systemd:
        name: nginx
        enabled: yes
        state: started
    
    - name: Reread supervisor config
      command: supervisorctl reread
      ignore_errors: yes
    
    - name: Update supervisor config
      command: supervisorctl update
      ignore_errors: yes
    
    # Health check
    - name: Wait for API to be ready
      uri:
        url: "http://localhost:8000/api/health"
        method: GET
        status_code: 200
      register: result
      until: result.status == 200
      retries: 10
      delay: 10
      ignore_errors: yes
    
    - name: Display deployment status
      debug:
        msg: "News Recommender API deployed successfully! Access at http://{{ ansible_host }}"
  
  handlers:
    - name: restart supervisor
      systemd:
        name: supervisor
        state: restarted
    
    - name: restart nginx
      systemd:
        name: nginx
        state: restarted
